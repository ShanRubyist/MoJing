<div id="app">
  <a-row>
    <a-col :md="4"></a-col>

    <a-col :sm="24" :md="16">
      <!--二级导航-->
      <a-tabs id="nav-tab" default-active-key="3" @change="change_tab">
        <a-tab-pane key="1">
          <span slot="tab">
            <i class="fa fa-newspaper-o"></i>&nbsp;最新动态
          </span>
          <a-empty>
            <a-button type="primary">
              去订阅
            </a-button>
          </a-empty>
          <!--        <new-feeds v-if="current[0] == 'new_feeds'"></new-feeds>-->
        </a-tab-pane>

        <a-tab-pane key="2">
          <span slot="tab">
            <i class="fa fa-rss"></i>&nbsp;RSS
          </span>
          <rss-list></rss-list>
        </a-tab-pane>

        <a-tab-pane key="3">
          <span slot="tab">
            <i class="fa fa-shopping-cart"></i>&nbsp;店铺监控
          </span>
          <shop-list></shop-list>
        </a-tab-pane>

        <a-button type="primary" slot="tabBarExtraContent" @click="show_add_dialog">
          <i class="fa fa-plus"></i>&nbsp;添加监控/订阅
        </a-button>

        <a-button slot="tabBarExtraContent">
          查看全部监控/订阅
        </a-button>

        <%= import_partial "home/new/add_dialog" %>

      </a-tabs>
    </a-col>

    <a-col :md="4"></a-col>
  </a-row>

  <a-back-top visibilityHeight="100px"/>

</div>

<script>
    <%= render "home/rss/rss_list.vue.js" %>
    <%= render "home/shop_spy/shop_list.vue.js" %>

    var app = new Vue({
        el: '#app',
        data: {
            dialog_loading: false,
            dialog_visible: false,
            new_form_data: {
                step: 0,
                type: 0,
                url: null,
                port: 80,
                retry_limit: null,
                proxy: null,
                status: true,
                cookies: ''
            }
        },
        methods: {
            change_tab: function (key) {
                if (key == 2) {
                    $.ajax({
                        url: window.location.href + 'mark_readed',
                        dataType: "script",
                        type: "PUT",
                        data: {
                            user_id: <%= current_user.id %>,
                            authenticity_token: $('meta[name="csrf-token"]').attr('content')
                        }
                    })
                }
            },
            handleCancel: function () {
                this.dialog_visible = false;
                this.dialog_loading = false;
            },
            handleOk: function () {
                this.dialog_loading = true;

                var that = this;
                var url = '';
                var setting = {};
                if (this.new_form_data.type == 1) {
                    url = '<%= probe_settings_url %>';
                    setting = {
                        authenticity_token: $('meta[name="csrf-token"]').attr('content'),
                        probe_setting: {
                            user_id: <%= current_user.id %>,
                            url: that.new_form_data.url,
                            port: that.new_form_data.port,
                            retry_limit: that.new_form_data.retry_limit,
                            proxy: that.new_form_data.proxy,
                            cookies: that.new_form_data.cookies,
                            status: that.new_form_data.status
                        }
                    }
                } else if (this.new_form_data.type == 2) {
                    url = '<%= web_spider_settings_url %>';
                    setting = {
                        authenticity_token: $('meta[name="csrf-token"]').attr('content'),
                        web_spider_setting: {
                            user_id: <%= current_user.id %>,
                            url: that.new_form_data.url,
                            port: that.new_form_data.port,
                            retry_limit: that.new_form_data.retry_limit,
                            proxy: that.new_form_data.proxy,
                            cookies: that.new_form_data.cookies,
                            status: that.new_form_data.status
                        }
                    }
                }
                axios.post(url, setting, {
                    headers: {
                        'Accept': 'application/json'
                    }
                }).then(function (reason) {
                    that.$message.info(reason.data.message);
                    that.dialog_loading = false;
                    that.dialog_visible = false;
                    that.clear_new_form_data();
                }).catch(function (reason) {
                    that.$message.error(reason.toString());
                    that.dialog_loading = false;
                })
            },
            clear_new_form_data: function () {
                this.new_form_data = {
                    step: 0,
                    type: 0,
                    url: null,
                    port: 80,
                    retry_limit: null,
                    proxy: null,
                    status: true,
                    cookies: ''
                }
            },
            show_add_dialog: function () {
                this.dialog_visible = true
            },
            next_step: function () {
                this.new_form_data.step += 1;
            }
        },
        mounted: function () {
            window.addEventListener('scroll', this.handleScroll);
        }
    })
</script>
